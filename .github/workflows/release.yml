name: Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write
  pull-requests: read

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        # æž„å»ºå¤šä¸ªå¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: darwin
            goarch: amd64
            suffix: darwin-amd64
          - goos: darwin
            goarch: arm64
            suffix: darwin-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-${{ matrix.goos }}-${{ matrix.goarch }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.goos }}-${{ matrix.goarch }}-go-
          ${{ runner.os }}-go-
        
    - name: Get dependencies
      run: go mod download

    - name: Verify required files
      run: |
        # æ£€æŸ¥åµŒå…¥æ¨¡æ¿æ‰€éœ€çš„æ–‡ä»¶
        echo "ðŸ” æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        for file in main.go embed.go views/version/index.html views/auth/login.html config.yaml README.md; do
          if [[ ! -f "$file" ]]; then
            echo "âŒ ç¼ºå°‘å¿…è¦æ–‡ä»¶: $file"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°: $file"
        done

    - name: Build binary with embedded templates
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        # èŽ·å–æž„å»ºä¿¡æ¯
        BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        GIT_COMMIT=$(git rev-parse --short HEAD)
        VERSION=${{ github.ref_name }}
        
        echo "ðŸ”¨ æž„å»º ${VERSION} for ${{ matrix.goos }}/${{ matrix.goarch }} (åµŒå…¥æ¨¡æ¿)"
        
        # æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆåµŒå…¥æ¨¡æ¿ï¼‰
        LDFLAGS="-s -w -X 'main.Version=${VERSION}' -X 'main.BuildTime=${BUILD_TIME}' -X 'main.GitCommit=${GIT_COMMIT}'"
        
        # åˆ›å»ºéƒ¨ç½²è¯´æ˜Žæ–‡ä»¶
        cat > DEPLOY.md << 'EOF'
        # Gover éƒ¨ç½²è¯´æ˜Ž

        ## å¿«é€Ÿéƒ¨ç½²

        1. è§£åŽ‹æ–‡ä»¶ï¼š
           ```bash
           tar -xzf gover-*.tar.gz  # Linux/macOS
           unzip gover-*.zip        # Windows
           cd gover-*
           ```

        2. å¤åˆ¶é…ç½®æ–‡ä»¶ï¼š
           ```bash
           cp config.yaml.example config.yaml
           ```

        3. ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š
           ```bash
           vim config.yaml  # Linux/macOS
           notepad config.yaml  # Windows
           ```

        4. è¿è¡Œåº”ç”¨ï¼š
           ```bash
           ./gover          # Linux/macOS
           gover.exe        # Windows
           ```

        ## æ¨¡æ¿æ–‡ä»¶

        æ­¤ç‰ˆæœ¬å·²å°†æ¨¡æ¿æ–‡ä»¶åµŒå…¥åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œæ— éœ€é¢å¤–çš„ views ç›®å½•ã€‚

        ## æ€§èƒ½é€‰é¡¹

        - é»˜è®¤æ¨¡å¼: `./gover`
        - å¿«é€Ÿæ¨¡å¼: `./gover --fast --skip-fetch`
        - è°ƒè¯•æ¨¡å¼: `./gover --debug`

        ## æƒé™é—®é¢˜

        å¦‚æžœé‡åˆ° Git æƒé™é—®é¢˜ï¼Œè¿è¡Œï¼š
        ```bash
        ./gover --fix-git
        ```

        ## æœåŠ¡æ¨¡å¼ (Linux)

        ```bash
        # åˆ›å»º systemd æœåŠ¡
        sudo tee /etc/systemd/system/gover.service > /dev/null << EOL
        [Unit]
        Description=Gover Git Version Manager
        After=network.target

        [Service]
        Type=simple
        User=www-data
        WorkingDirectory=/path/to/gover
        ExecStart=/path/to/gover/gover --fast
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target
        EOL

        # å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
        sudo systemctl enable gover
        sudo systemctl start gover
        ```
        EOF
        
        if [ "${{ matrix.goos }}" = "windows" ]; then
          # Windows: æž„å»º .exe æ–‡ä»¶
          go build -ldflags "${LDFLAGS}" -o gover.exe .
          
          # åˆ›å»ºå‘å¸ƒåŒ…ï¼ˆåªåŒ…å«å¿…è¦æ–‡ä»¶ï¼Œä¸åŒ…å« views ç›®å½•ï¼‰
          cp config.yaml config.yaml.example
          zip -r gover-${{ github.ref_name }}-${{ matrix.suffix }}.zip \
            gover.exe \
            config.yaml.example \
            README.md \
            DEPLOY.md
            
          echo "âœ… Windows åŒ…åˆ›å»ºå®Œæˆ: gover-${{ github.ref_name }}-${{ matrix.suffix }}.zip"
        else
          # Linux/macOS: æž„å»ºæ— åŽç¼€æ–‡ä»¶
          go build -ldflags "${LDFLAGS}" -o gover .
          
          # åˆ›å»ºå‘å¸ƒåŒ…ï¼ˆåªåŒ…å«å¿…è¦æ–‡ä»¶ï¼Œä¸åŒ…å« views ç›®å½•ï¼‰
          cp config.yaml config.yaml.example
          tar -czf gover-${{ github.ref_name }}-${{ matrix.suffix }}.tar.gz \
            gover \
            config.yaml.example \
            README.md \
            DEPLOY.md
            
          echo "âœ… Unix åŒ…åˆ›å»ºå®Œæˆ: gover-${{ github.ref_name }}-${{ matrix.suffix }}.tar.gz"
        fi
        
        # æ˜¾ç¤ºæž„å»ºç»“æžœ
        if [ "${{ matrix.goos }}" = "windows" ]; then
          ls -lh gover.exe gover-${{ github.ref_name }}-${{ matrix.suffix }}.zip
        else
          ls -lh gover gover-${{ github.ref_name }}-${{ matrix.suffix }}.tar.gz
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gover-${{ matrix.suffix }}
        path: |
          gover-${{ github.ref_name }}-${{ matrix.suffix }}.*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Generate release notes
      id: release_notes
      run: |
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        cat > release_notes.md << 'EOF'
        ## ðŸš€ Gover ${{ steps.version.outputs.VERSION }} å‘å¸ƒ

        ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        
        è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼š
        
        - **Linux AMD64**: `gover-${{ steps.version.outputs.VERSION }}-linux-amd64.tar.gz`
        - **Linux ARM64**: `gover-${{ steps.version.outputs.VERSION }}-linux-arm64.tar.gz`
        - **macOS Intel**: `gover-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz`
        - **macOS Apple Silicon**: `gover-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz`

        ### ðŸ› ï¸ å®‰è£…æ–¹æ³•

        1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
        2. è§£åŽ‹åˆ°ç›®æ ‡ç›®å½•ï¼š
           ```bash
           tar -xzf gover-*.tar.gz  # Linux/macOS
           ```
        3. å¤åˆ¶é…ç½®æ–‡ä»¶ï¼š
           ```bash
           cp config.yaml.example config.yaml
           ```
        4. ç¼–è¾‘é…ç½®æ–‡ä»¶å¹¶è¿è¡Œï¼š
           ```bash
           ./gover          # Linux/macOS
           ```

        ### ðŸ“ ä½¿ç”¨è¯´æ˜Ž

        è¯¦ç»†çš„é…ç½®å’Œä½¿ç”¨è¯´æ˜Žè¯·å‚è€ƒé¡¹ç›® README.md å’Œ DEPLOY.md æ–‡ä»¶ã€‚

        ### âš¡ æ€§èƒ½é€‰é¡¹

        - **é»˜è®¤æ¨¡å¼**: `./gover`
        - **å¿«é€Ÿæ¨¡å¼**: `./gover --fast --skip-fetch` (æŽ¨èç”Ÿäº§çŽ¯å¢ƒ)
        - **è°ƒè¯•æ¨¡å¼**: `./gover --debug`

        ### ðŸ”§ æŠ€æœ¯ç‰¹æ€§

        - ðŸ·ï¸ æ™ºèƒ½ç‰ˆæœ¬æŽ’åº
        - ðŸ”„ ä¸€é”®ç‰ˆæœ¬å›žæ»š
        - ðŸ“ å¤šé¡¹ç›®ç®¡ç†  
        - ðŸ” å®‰å…¨è®¤è¯ç³»ç»Ÿ
        - ðŸ“± å“åº”å¼ç•Œé¢
        - ðŸŒ çŽ°ä»£åŒ– Web UI
        - ðŸ“¦ **æ¨¡æ¿æ–‡ä»¶åµŒå…¥** (æ— éœ€é¢å¤–æ–‡ä»¶)
        - âš¡ **ç¼“å­˜ä¼˜åŒ–** (å¿«é€Ÿå“åº”)
        - ðŸš€ **é›¶ä¾èµ–éƒ¨ç½²** (å•äºŒè¿›åˆ¶æ–‡ä»¶)

        ---
        
        **å®Œæ•´æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹é¡¹ç›®æäº¤åŽ†å²ã€‚**
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: "Gover ${{ steps.version.outputs.VERSION }}"
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          ./artifacts/*/gover-${{ steps.version.outputs.VERSION }}-*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload to latest release
      if: ${{ !contains(steps.version.outputs.VERSION, 'beta') && !contains(steps.version.outputs.VERSION, 'alpha') && !contains(steps.version.outputs.VERSION, 'rc') }}
      run: |
        echo "æ­£å¼ç‰ˆæœ¬å·²å‘å¸ƒ: ${{ steps.version.outputs.VERSION }}" 