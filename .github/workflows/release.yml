name: Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write
  pull-requests: read

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        # æž„å»ºå¤šä¸ªå¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: linux
            goarch: 386
            suffix: linux-386
          - goos: darwin
            goarch: amd64
            suffix: darwin-amd64
          - goos: darwin
            goarch: arm64
            suffix: darwin-arm64
          - goos: windows
            goarch: amd64
            suffix: windows-amd64
          - goos: windows
            goarch: arm64
            suffix: windows-arm64
          - goos: windows
            goarch: 386
            suffix: windows-386

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-${{ matrix.goos }}-${{ matrix.goarch }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.goos }}-${{ matrix.goarch }}-go-
          ${{ runner.os }}-go-
        
    - name: Get dependencies
      run: go mod download

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        # èŽ·å–æž„å»ºä¿¡æ¯
        BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        GIT_COMMIT=$(git rev-parse --short HEAD)
        VERSION=${{ github.ref_name }}
        
        # æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
        LDFLAGS="-s -w -X 'main.Version=${VERSION}' -X 'main.BuildTime=${BUILD_TIME}' -X 'main.GitCommit=${GIT_COMMIT}'"
        
        if [ "${{ matrix.goos }}" = "windows" ]; then
          # Windows: äºŒè¿›åˆ¶æ–‡ä»¶æœ‰ .exe åŽç¼€ï¼Œä½†åŽ‹ç¼©åŒ…åç§°ä¸åŒ…å« .exe
          go build -ldflags "${LDFLAGS}" -o gover.exe .
          zip -r gover-${{ github.ref_name }}-${{ matrix.suffix }}.zip gover.exe config.yaml README.md views/
        else
          # Linux/macOS: æ— åŽç¼€
          go build -ldflags "${LDFLAGS}" -o gover .
          tar -czf gover-${{ github.ref_name }}-${{ matrix.suffix }}.tar.gz gover config.yaml README.md views/
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gover-${{ matrix.suffix }}
        path: |
          gover-${{ github.ref_name }}-${{ matrix.suffix }}.*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Generate release notes
      id: release_notes
      run: |
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        cat > release_notes.md << 'EOF'
        ## ðŸš€ Gover ${{ steps.version.outputs.VERSION }} å‘å¸ƒ

        ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        
        è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼š
        
        - **Linux AMD64**: `gover-${{ steps.version.outputs.VERSION }}-linux-amd64.tar.gz`
        - **Linux ARM64**: `gover-${{ steps.version.outputs.VERSION }}-linux-arm64.tar.gz`
        - **Linux 386**: `gover-${{ steps.version.outputs.VERSION }}-linux-386.tar.gz`
        - **macOS Intel**: `gover-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz`
        - **macOS Apple Silicon**: `gover-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz`
        - **Windows AMD64**: `gover-${{ steps.version.outputs.VERSION }}-windows-amd64.zip`
        - **Windows ARM64**: `gover-${{ steps.version.outputs.VERSION }}-windows-arm64.zip`
        - **Windows 386**: `gover-${{ steps.version.outputs.VERSION }}-windows-386.zip`

        ### ðŸ› ï¸ å®‰è£…æ–¹æ³•

        1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
        2. è§£åŽ‹åˆ°ç›®æ ‡ç›®å½•
        3. æ ¹æ® README.md é…ç½® config.yaml
        4. è¿è¡Œ `./gover` (Linux/macOS) æˆ– `gover.exe` (Windows)

        ### ðŸ“ ä½¿ç”¨è¯´æ˜Ž

        è¯¦ç»†çš„é…ç½®å’Œä½¿ç”¨è¯´æ˜Žè¯·å‚è€ƒé¡¹ç›® README.md æ–‡ä»¶ã€‚

        ### ðŸ”§ æŠ€æœ¯ç‰¹æ€§

        - ðŸ·ï¸ æ™ºèƒ½ç‰ˆæœ¬æŽ’åº
        - ðŸ”„ ä¸€é”®ç‰ˆæœ¬å›žæ»š
        - ðŸ“ å¤šé¡¹ç›®ç®¡ç†
        - ðŸ” å®‰å…¨è®¤è¯ç³»ç»Ÿ
        - ðŸ“± å“åº”å¼ç•Œé¢
        - ðŸŒ çŽ°ä»£åŒ– Web UI

        ---
        
        **å®Œæ•´æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹é¡¹ç›®æäº¤åŽ†å²ã€‚**
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: "Gover ${{ steps.version.outputs.VERSION }}"
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          ./artifacts/*/gover-${{ steps.version.outputs.VERSION }}-*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload to latest release
      if: ${{ !contains(steps.version.outputs.VERSION, 'beta') && !contains(steps.version.outputs.VERSION, 'alpha') && !contains(steps.version.outputs.VERSION, 'rc') }}
      run: |
        echo "æ­£å¼ç‰ˆæœ¬å·²å‘å¸ƒ: ${{ steps.version.outputs.VERSION }}" 