# 🔐 Gover - 安全升级说明

## 认证系统升级

本项目已从 **HTTP 基本认证** 升级为更安全的 **Session 认证系统**。

### 🆕 新特性

#### 1. 页面登录
- ✅ 美观的登录页面，替代浏览器弹窗
- ✅ 用户友好的界面设计
- ✅ 响应式设计，支持移动设备
- ✅ 错误提示和表单验证

#### 2. Session 认证
- ✅ 基于 Cookie 的 Session 管理
- ✅ 安全的 Session 密钥配置
- ✅ 可配置的会话超时时间
- ✅ 自动会话过期检查
- ✅ 配置变更检测（密码修改后自动失效旧 Session）
- ✅ 命令行清除所有 Session

#### 3. 密码安全
- ✅ SHA256 哈希加密
- ✅ 加盐处理防止彩虹表攻击
- ✅ 密码不以明文形式传输或存储

#### 4. 记住我功能
- ✅ 可选的长期登录状态
- ✅ 可配置的记住天数
- ✅ 安全的 Cookie 设置

#### 5. 用户体验
- ✅ 登录后自动重定向到原页面
- ✅ 优雅的退出登录功能
- ✅ 会话状态实时检查

### 🔧 配置说明

在 `config.yaml` 中新增的安全配置：

```yaml
security:
  enable_auth: true                                    # 启用认证
  session_timeout: 3600                               # 会话超时(秒)
  session_secret: "gover-secret-key"   # Session 密钥
  remember_me_days: 7                                  # 记住我天数
```

### 🚀 使用方式

1. **首次访问**: 自动跳转到登录页面
2. **登录**: 输入用户名和密码
3. **记住我**: 勾选可保持7天登录状态
4. **退出**: 点击右上角退出按钮

### 🛡️ 安全优势

| 特性 | 旧版本 (HTTP Basic) | 新版本 (Session) |
|------|-------------------|------------------|
| 认证方式 | 浏览器弹窗 | 页面登录 |
| 密码传输 | Base64编码 | 哈希加密 |
| 会话管理 | 每次请求认证 | Session 状态 |
| 记住登录 | 不支持 | 支持配置 |
| 用户体验 | 较差 | 优秀 |
| 安全级别 | 中等 | 高 |

### 🔧 Session 管理功能

#### 自动失效机制
当检测到以下情况时，Session 会自动失效：
- 会话超时（可配置）
- 用户名或密码被修改
- Session 密钥被更改

#### 配置变更检测
系统会为每个 Session 存储配置哈希值：
```
config_hash = SHA256(username + password + session_secret)
```
当配置发生变更时，所有旧的 Session 会被自动标记为无效。

#### 管理员功能
- **清除所有 Session**: 使用命令行参数 `-clear-sessions`
- **强制重新登录**: 适用于安全事件或系统维护
- **即时生效**: 清除后所有用户需要重新登录

#### 命令行用法
```bash
# 清除所有 Session
./gover -clear-sessions

# 查看帮助
./gover --help
```

### 📝 技术实现

- **Session 存储**: 使用 `gorilla/sessions` 库
- **密码哈希**: SHA256 + 自定义盐值
- **Cookie 安全**: HttpOnly、Secure 等安全设置
- **中间件**: 统一的认证检查机制
- **配置哈希**: SHA256 算法检测配置变更

### ⚠️ 注意事项

1. **Session 密钥**: 生产环境请修改默认密钥
2. **HTTPS**: 生产环境建议启用 HTTPS
3. **密码强度**: 建议使用强密码
4. **会话超时**: 根据需要调整超时时间
5. **配置变更**: 修改密码后，所有现有 Session 会自动失效
6. **Session 管理**: 可使用命令行参数 `-clear-sessions` 强制所有用户重新登录

### 🔄 迁移指南

从旧版本升级无需特殊操作：

1. 更新配置文件添加新的安全配置项
2. 重启应用程序
3. 首次访问时会跳转到新的登录页面

---

*本升级提供了更好的安全性和用户体验，同时保持了配置的向后兼容性。* 